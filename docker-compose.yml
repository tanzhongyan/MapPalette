# MapPaletteV2 - Complete Stack
# Usage:
#   Start:    docker compose up -d
#   Stop:     docker compose down
#   Destroy:  docker compose down -v
#   Logs:     docker compose logs -f [service-name]

name: mappalette

services:
  # ====================
  # SUPABASE CORE (Minimal Setup)
  # ====================

  supabase-db:
    container_name: mappalette-supabase-db
    image: supabase/postgres:15.8.1.085
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres', '-h', 'localhost']
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_HOST: /var/run/postgresql
      POSTGRES_PORT: 5432
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXP: ${JWT_EXPIRY:-3600}
    volumes:
      # Mount Supabase core database initialization scripts
      - ./backend/db/volumes/db/_supabase.sql:/docker-entrypoint-initdb.d/migrations/00-_supabase.sql:Z
      - ./backend/db/volumes/db/jwt.sql:/docker-entrypoint-initdb.d/migrations/01-jwt.sql:Z
      - ./backend/db/volumes/db/logs.sql:/docker-entrypoint-initdb.d/migrations/02-logs.sql:Z
      - ./backend/db/volumes/db/pooler.sql:/docker-entrypoint-initdb.d/migrations/03-pooler.sql:Z
      - ./backend/db/volumes/db/realtime.sql:/docker-entrypoint-initdb.d/migrations/04-realtime.sql:Z
      - ./backend/db/volumes/db/webhooks.sql:/docker-entrypoint-initdb.d/migrations/05-webhooks.sql:Z
      - ./backend/db/volumes/db/roles.sql:/docker-entrypoint-initdb.d/migrations/99-roles.sql:Z
      # Database data persistence
      - supabase-db-data:/var/lib/postgresql/data
    networks:
      - mappalette-network
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      - -c
      - log_min_messages=warning

  supabase-auth:
    container_name: mappalette-supabase-auth
    image: supabase/gotrue:v2.177.0
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:9999/health']
      timeout: 5s
      interval: 5s
      retries: 3
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: ${API_EXTERNAL_URL}
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://supabase_auth_admin:${POSTGRES_PASSWORD}@mappalette-supabase-db:5432/${POSTGRES_DB}
      GOTRUE_SITE_URL: ${SITE_URL}
      GOTRUE_URI_ALLOW_LIST: ${ADDITIONAL_REDIRECT_URLS:-}
      GOTRUE_DISABLE_SIGNUP: ${DISABLE_SIGNUP:-false}
      GOTRUE_JWT_ADMIN_ROLES: service_role
      GOTRUE_JWT_AUD: authenticated
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_JWT_EXP: ${JWT_EXPIRY:-3600}
      GOTRUE_JWT_SECRET: ${JWT_SECRET}
      GOTRUE_EXTERNAL_EMAIL_ENABLED: ${ENABLE_EMAIL_SIGNUP:-true}
      GOTRUE_MAILER_AUTOCONFIRM: 'true'
      GOTRUE_MAILER_EXTERNAL_HOSTS: localhost,localhost:3000,localhost:8000
      # CORS Configuration for GoTrue
      GOTRUE_EXTERNAL_CORS_ALLOWED_ORIGINS: '*'
      GOTRUE_EXTERNAL_CORS_ALLOWED_HEADERS: 'Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version'
    networks:
      - mappalette-network

  supabase-rest:
    container_name: mappalette-supabase-rest
    image: postgrest/postgrest:v12.2.12
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://authenticator:${POSTGRES_PASSWORD}@mappalette-supabase-db:5432/${POSTGRES_DB}
      PGRST_DB_SCHEMAS: ${PGRST_DB_SCHEMAS:-public,storage,graphql_public}
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_USE_LEGACY_GUCS: 'false'
    networks:
      - mappalette-network

  supabase-storage:
    container_name: mappalette-supabase-storage
    image: supabase/storage-api:v1.32.0
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://supabase-storage:5000/status']
      timeout: 5s
      interval: 5s
      retries: 3
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-rest:
        condition: service_started
      imgproxy:
        condition: service_started
    environment:
      ANON_KEY: ${SUPABASE_ANON_KEY}
      SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      POSTGREST_URL: http://supabase-rest:3000
      PGRST_JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://supabase_storage_admin:${POSTGRES_PASSWORD}@mappalette-supabase-db:5432/${POSTGRES_DB}
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      REGION: us-east-1
      GLOBAL_S3_BUCKET: supabase-storage
      ENABLE_IMAGE_TRANSFORMATION: 'true'
      IMGPROXY_URL: http://imgproxy:8080
    ports:
      - "${STORAGE_PORT:-5000}:5000"
    volumes:
      - supabase-storage-data:/var/lib/storage
    networks:
      - mappalette-network

  imgproxy:
    container_name: mappalette-imgproxy
    image: darthsim/imgproxy:v3.8
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'imgproxy', 'health']
      timeout: 5s
      interval: 5s
      retries: 3
    environment:
      IMGPROXY_BIND: ':8080'
      IMGPROXY_LOCAL_FILESYSTEM_ROOT: /var/lib/storage
      IMGPROXY_USE_ETAG: 'true'
      IMGPROXY_ENABLE_WEBP_DETECTION: ${IMGPROXY_ENABLE_WEBP_DETECTION:-true}
    volumes:
      - supabase-storage-data:/var/lib/storage:ro
    networks:
      - mappalette-network

  supabase-kong:
    container_name: mappalette-supabase-kong
    image: kong:2.8.1
    restart: unless-stopped
    ports:
      - "${KONG_HTTP_PORT:-8000}:8000"
    environment:
      KONG_DATABASE: 'off'
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/config/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
    volumes:
      - ./backend/db/kong.yml:/usr/local/kong/config/kong.yml:ro
    networks:
      - mappalette-network

  supabase-studio:
    container_name: mappalette-supabase-studio
    image: supabase/studio:2025.11.26-sha-8f096b5 # Using a pinned version is recommended
    restart: unless-stopped
    ports:
      - "${STUDIO_PORT:-8081}:3000"
    environment:
      HOSTNAME: "::"
      SUPABASE_URL: http://supabase-kong:8000
      SUPABASE_PUBLIC_URL: ${SUPABASE_PUBLIC_URL:-http://localhost:8000}
      STUDIO_PG_META_URL: http://supabase-meta:8080
      POSTGRES_HOST: mappalette-supabase-db
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PG_META_CRYPTO_KEY: ${PG_META_CRYPTO_KEY}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      DEFAULT_ORGANIZATION_NAME: MapPalette
      DEFAULT_PROJECT_NAME: MapPaletteV2
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:3000/api/platform/profile').then((r) => {if (r.status !== 200) throw new Error(r.status)})"
        ]
      timeout: 10s
      interval: 5s
      retries: 3
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-rest:
        condition: service_started
      supabase-kong:
        condition: service_started
      supabase-meta:
        condition: service_healthy
    networks:
      - mappalette-network

  supabase-meta:
    container_name: mappalette-supabase-meta
    image: supabase/postgres-meta:v0.93.1
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "try { require('http').get('http://localhost:8080', (res) => res.statusCode === 200 ? process.exit(0) : process.exit(1)) } catch (err) { process.exit(1) }"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: ${POSTGRES_HOST}
      PG_META_DB_PORT: ${POSTGRES_PORT}
      PG_META_DB_NAME: ${POSTGRES_DB}
      PG_META_DB_USER: supabase_admin
      PG_META_DB_PASSWORD: ${POSTGRES_PASSWORD}
      CRYPTO_KEY: ${PG_META_CRYPTO_KEY}
    networks:
      - mappalette-network
    ports:
      - "8082:8080" # Exposing meta for debugging

  # ====================
  # REDIS CACHE
  # ====================

  redis:
    container_name: mappalette-redis
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - mappalette-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

  # ====================
  # PRISMA INIT SERVICE
  # ====================
  # Runs migrations and generates Prisma client before services start

  prisma-init:
    build:
      context: .
      dockerfile: ./backend/services/atomic/user-service/Dockerfile
    container_name: mappalette-prisma-init
    restart: "no"
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@mappalette-supabase-db:5432/${POSTGRES_DB}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - PRISMA_FORCE_NAPI=1
    env_file:
      - .env
    networks:
      - mappalette-network
    volumes:
      - prisma-client-data:/app/node_modules/.prisma
    working_dir: /app
    command: >
      sh -c "
      echo 'Waiting for database migrations...' &&
      npx prisma migrate deploy --schema=/app/shared/prisma/schema.prisma &&
      echo 'Generating Prisma client...' &&
      npx prisma generate --schema=/app/shared/prisma/schema.prisma &&
      echo 'Prisma initialization complete!'
      "

  # ====================
  # STORAGE INIT SERVICE
  # ====================
  # Creates storage buckets after storage service is ready
  # Uses direct database access as it's more reliable than the HTTP API for self-hosted setups

  storage-init:
    image: postgres:15-alpine
    container_name: mappalette-storage-init
    restart: "no"
    depends_on:
      supabase-storage:
        condition: service_healthy
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
    networks:
      - mappalette-network
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating storage buckets via database..."
        sleep 3
        
        psql -h mappalette-supabase-db -U postgres -d postgres -c "
          INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
          VALUES 
            ('profile-pictures', 'profile-pictures', true, 5242880, ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif']),
            ('route-images', 'route-images', true, 10485760, ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp']),
            ('route-images-optimized', 'route-images-optimized', true, 10485760, ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp'])
          ON CONFLICT (id) DO UPDATE SET
            public = EXCLUDED.public,
            file_size_limit = EXCLUDED.file_size_limit,
            allowed_mime_types = EXCLUDED.allowed_mime_types;
        "
        
        echo "Storage buckets created successfully!"
        
        echo "Setting up storage RLS policies..."
        psql -h mappalette-supabase-db -U postgres -d postgres -c "
          -- Drop existing policies if they exist
          DROP POLICY IF EXISTS \"Allow public read access for public buckets\" ON storage.objects;
          DROP POLICY IF EXISTS \"Allow authenticated uploads\" ON storage.objects;
          DROP POLICY IF EXISTS \"Allow authenticated updates\" ON storage.objects;
          DROP POLICY IF EXISTS \"Allow authenticated deletes\" ON storage.objects;
          DROP POLICY IF EXISTS \"Allow service role full access\" ON storage.objects;
          
          -- Policy 1: Allow public read access to objects in public buckets
          CREATE POLICY \"Allow public read access for public buckets\" ON storage.objects
            FOR SELECT USING (bucket_id IN (SELECT id FROM storage.buckets WHERE public = true));
          
          -- Policy 2: Allow authenticated users to upload to their own folder
          CREATE POLICY \"Allow authenticated uploads\" ON storage.objects
            FOR INSERT TO authenticated
            WITH CHECK (bucket_id IN (SELECT id FROM storage.buckets WHERE public = true) AND (storage.foldername(name))[1] = auth.uid()::text);
          
          -- Policy 3: Allow authenticated users to update their own objects
          CREATE POLICY \"Allow authenticated updates\" ON storage.objects
            FOR UPDATE TO authenticated
            USING ((storage.foldername(name))[1] = auth.uid()::text)
            WITH CHECK ((storage.foldername(name))[1] = auth.uid()::text);
          
          -- Policy 4: Allow authenticated users to delete their own objects
          CREATE POLICY \"Allow authenticated deletes\" ON storage.objects
            FOR DELETE TO authenticated
            USING ((storage.foldername(name))[1] = auth.uid()::text);
          
          -- Policy 5: Allow service_role full access
          CREATE POLICY \"Allow service role full access\" ON storage.objects
            FOR ALL TO service_role USING (true) WITH CHECK (true);
        "
        
        echo "Storage RLS policies created!"
        psql -h mappalette-supabase-db -U postgres -d postgres -c "SELECT policyname, cmd, roles FROM pg_policies WHERE schemaname = 'storage' AND tablename = 'objects';"

  # ====================
  # ATOMIC SERVICES
  # ====================
  # Migrations are run via: npm run db:migrate (see package.json)
  # Prisma client is generated during service build time

  user-service:
    build:
      context: .
      dockerfile: ./backend/services/atomic/user-service/Dockerfile
    container_name: mappalette-user-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${USER_SERVICE_PORT:-3001}:5000"
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    networks:
      - mappalette-network
    volumes:
      - prisma-client-data:/app/node_modules/.prisma
    working_dir: /app/services/atomic/user-service

  post-service:
    build:
      context: .
      dockerfile: ./backend/services/atomic/post-service/Dockerfile
    container_name: mappalette-post-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${POST_SERVICE_PORT:-3002}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - USER_SERVICE_URL=http://user-service:5000
      - INTERNAL_SERVICE_KEY=${INTERNAL_SERVICE_KEY}
    networks:
      - mappalette-network
    volumes:
      - prisma-client-data:/app/node_modules/.prisma
    working_dir: /app/services/atomic/post-service

  interaction-service:
    build:
      context: .
      dockerfile: ./backend/services/atomic/interaction-service/Dockerfile
    container_name: mappalette-interaction-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${INTERACTION_SERVICE_PORT:-3003}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
    networks:
      - mappalette-network
    volumes:
      - ./backend/shared:/app/shared:ro
      - prisma-client-data:/app/node_modules/.prisma

  follow-service:
    build:
      context: .
      dockerfile: ./backend/services/atomic/follow-service/Dockerfile
    container_name: mappalette-follow-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${FOLLOW_SERVICE_PORT:-3007}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
    networks:
      - mappalette-network
    volumes:
      - ./backend/shared:/app/shared:ro
      - prisma-client-data:/app/node_modules/.prisma

  # ====================
  # COMPOSITE SERVICES
  # ====================

  feed-service:
    build:
      context: .
      dockerfile: ./backend/services/composite/feed-service/Dockerfile
    container_name: mappalette-feed-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      user-service:
        condition: service_started
      post-service:
        condition: service_started
      interaction-service:
        condition: service_started
      follow-service:
        condition: service_started
    ports:
      - "${FEED_SERVICE_PORT:-3004}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - USER_SERVICE_URL=http://user-service:5000
      - POST_SERVICE_URL=http://post-service:5000
      - INTERACTION_SERVICE_URL=http://interaction-service:5000
      - FOLLOW_SERVICE_URL=http://follow-service:5000
    networks:
      - mappalette-network
    volumes:
      - ./backend/shared:/app/shared:ro
      - prisma-client-data:/app/node_modules/.prisma

  profile-service:
    build:
      context: .
      dockerfile: ./backend/services/composite/profile-service/Dockerfile
    container_name: mappalette-profile-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      user-service:
        condition: service_started
      post-service:
        condition: service_started
    ports:
      - "${PROFILE_SERVICE_PORT:-3006}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - USER_SERVICE_URL=http://user-service:5000
      - POST_SERVICE_URL=http://post-service:5000
      - INTERACTION_SERVICE_URL=http://interaction-service:5000
      - FOLLOW_SERVICE_URL=http://follow-service:5000
    networks:
      - mappalette-network
    volumes:
      - ./backend/shared:/app/shared:ro
      - prisma-client-data:/app/node_modules/.prisma

  social-interaction-service:
    build:
      context: .
      dockerfile: ./backend/services/composite/social-interaction-service/Dockerfile
    container_name: mappalette-social-interaction-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      interaction-service:
        condition: service_started
      follow-service:
        condition: service_started
    ports:
      - "${SOCIAL_INTERACTION_SERVICE_PORT:-3005}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - USER_SERVICE_URL=http://user-service:5000
      - POST_SERVICE_URL=http://post-service:5000
      - INTERACTION_SERVICE_URL=http://interaction-service:5000
      - FOLLOW_SERVICE_URL=http://follow-service:5000
      - INTERNAL_SERVICE_KEY=${INTERNAL_SERVICE_KEY}
    networks:
      - mappalette-network
    volumes:
      - ./backend/shared:/app/shared:ro
      - prisma-client-data:/app/node_modules/.prisma

  explore-routes-service:
    build:
      context: .
      dockerfile: ./backend/services/composite/explore-routes-service/Dockerfile
    container_name: mappalette-explore-routes-service
    restart: unless-stopped
    depends_on:
      prisma-init:
        condition: service_completed_successfully
      supabase-db:
        condition: service_healthy
      post-service:
        condition: service_started
      user-service:
        condition: service_started
    ports:
      - "${EXPLORE_ROUTES_SERVICE_PORT:-3008}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - POST_SERVICE_URL=http://post-service:5000
      - USER_SERVICE_URL=http://user-service:5000
      - INTERACTION_SERVICE_URL=http://interaction-service:5000
    networks:
      - mappalette-network
    volumes:
      - ./backend/shared:/app/shared:ro
      - prisma-client-data:/app/node_modules/.prisma

  leaderboard-service:
    build:
      context: ./backend/services/composite/leaderboard-service
      dockerfile: Dockerfile
    container_name: mappalette-leaderboard-service
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
      user-service:
        condition: service_started
    ports:
      - "${LEADERBOARD_SERVICE_PORT:-3009}:8080"
    env_file:
      - .env
    environment:
      - USER_SERVICE_URL=http://user-service:5000
    networks:
      - mappalette-network
    volumes:
      - prisma-client-data:/app/node_modules/.prisma

  user-discovery-service:
    build:
      context: ./backend/services/composite/user-discovery-service
      dockerfile: Dockerfile
    container_name: mappalette-user-discovery-service
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
      user-service:
        condition: service_started
      follow-service:
        condition: service_started
    ports:
      - "${USER_DISCOVERY_SERVICE_PORT:-3010}:5000"
    env_file:
      - .env
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - USER_SERVICE_URL=http://user-service:5000
      - FOLLOW_SERVICE_URL=http://follow-service:5000
    networks:
      - mappalette-network
    volumes:
      - prisma-client-data:/app/node_modules/.prisma

  # ====================
  # FRONTEND
  # ====================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Supabase
        - VITE_SUPABASE_URL=${SUPABASE_PUBLIC_URL}
        - VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
        # API URLs - Core Services (use Caddy proxy instead of direct service ports)
        - VITE_API_URL=${VITE_API_URL:-http://localhost}
        - VITE_FEED_SERVICE_URL=${VITE_FEED_SERVICE_URL:-http://localhost}
        - VITE_USER_SERVICE_URL=${VITE_USER_SERVICE_URL:-http://localhost}
        - VITE_POST_SERVICE_URL=${VITE_POST_SERVICE_URL:-http://localhost}
        - VITE_INTERACTION_SERVICE_URL=${VITE_INTERACTION_SERVICE_URL:-http://localhost}
        - VITE_FOLLOW_SERVICE_URL=${VITE_FOLLOW_SERVICE_URL:-http://localhost}
        - VITE_SOCIAL_INTERACTION_URL=${VITE_SOCIAL_INTERACTION_URL:-http://localhost}
        - VITE_EXPLORE_ROUTES_URL=${VITE_EXPLORE_ROUTES_URL:-http://localhost}
        # Google Maps (both with and without VITE_ prefix)
        - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
        - GOOGLE_MAPS_MAP_ID=${GOOGLE_MAPS_MAP_ID}
        - VITE_GOOGLE_MAPS_API_KEY=${VITE_GOOGLE_MAPS_API_KEY}
        - VITE_GOOGLE_MAPS_MAP_ID=${VITE_GOOGLE_MAPS_MAP_ID}
        # Application
        - VITE_APP_NAME=MapPalette
        - VITE_APP_URL=${VITE_APP_URL:-http://localhost:3000}
        - VITE_APP_ENV=production
        # Features
        - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS:-false}
        - VITE_ENABLE_ERROR_REPORTING=${VITE_ENABLE_ERROR_REPORTING:-true}
        - VITE_ENABLE_DEBUG=false
    container_name: mappalette-frontend
    restart: unless-stopped
    depends_on:
      # Atomic Services
      - user-service
      - post-service
      - interaction-service
      - follow-service
      # Composite Services
      - feed-service
      - profile-service
      - social-interaction-service
      - explore-routes-service
      - leaderboard-service
      - user-discovery-service
      # Infrastructure
      - supabase-kong
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    networks:
      - mappalette-network

  # ====================
  # REVERSE PROXY
  # ====================

  caddy:
    container_name: mappalette-caddy
    image: caddy:2-alpine
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost/health']
      interval: 10s
      timeout: 5s
      retries: 3
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - caddy-logs:/var/log/caddy
    networks:
      - mappalette-network
    depends_on:
      - frontend
      - feed-service

networks:
  mappalette-network:
    name: mappalette-network
    driver: bridge

volumes:
  supabase-db-data:
  supabase-storage-data:
  redis-data:
  caddy-data:
  caddy-config:
  caddy-logs:
  prisma-client-data:
